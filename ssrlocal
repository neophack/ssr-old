#!/bin/bash
root="$(cd $(dirname $(realpath ${BASH_SOURCE})) && pwd)"
cd "$root"

user=${SUDO_USER:-$(whoami)}
home=$(eval echo ~$user)

red=$(tput setaf 1)
green=$(tput setaf 2)
reset=$(tput sgr0)

usage(){
    cat<<-EOF
	Usage: $(basename $0) CMD
	CMD:
	    start
	    stop
	    status
	    config
	    em
	    ping
	EOF
    exit 1
}

start(){
    #tmux new-session -d -s "ssr local" python ROOT/local.py -c ROOT/config-local.json
    case $(uname) in
        Linux)
            if (($EUID!=0));then
                sudo systemctl start ssrlocal
            else
                systemctl start ssrlocal
            fi
            ;;
        Darwin)
            launchctl load -w $home/Library/LaunchAgents/ssrlocal.plist
            ;;
    esac
}

stop(){
    #tmux kill-session -t "ssr local"
    case $(uname) in
        Linux)
            if (($EUID!=0));then
                sudo systemctl stop ssrlocal
            else
                systemctl stop ssrlocal
            fi
            ;;
        Darwin)
            launchctl unload -w $home/Library/LaunchAgents/ssrlocal.plist
            ;;
    esac
}

config(){
    editor=vi
    if command -v vim >/dev/null 2>&1;then
        editor=vim
    fi
    if [ ! -e $root/config-local.json ];then
        cp $root/config-local.json.example $root/config-local.json
    fi
    $editor $root/config-local.json
    #TODO restart if needed
}

ping(){
    server="$(python parseConfig.py server)"
    if [ -n "$server" ];then
        echo "Try to $(tput bold)ping$(tput sgr0) server: $(tput setaf 1)$server$(tput sgr0)..."
        /usr/bin/ping -c 8 "$server"
    fi
}

check(){
    server="$(python parseConfig.py server)"
    if echo "$server" | grep -qE '^[0-9]+(\.[0-9]+){3}$';then
        echo "Server: ${green}$server${reset} is ip address"
        serverIP="$server"
        echo "Server ip: ${green}$serverIP${reset}"
    else
        echo -e "Server: ${green}$server${reset} is domain name,\ntry to lookup its ip address..."
        serverIP="$(nslookup $server | perl -ne 'print $1 if/^Address\s*:\s*(\d+(\.\d+){3})$/')"
        echo "Get server ip by nslookup: ${green}$serverIP${reset}"
    fi
    echo "-------------------------------------------"
    localPort="$(python parseConfig.py local_port)"
    echo "Local port: ${green}$localPort${reset}"
    serverFromCurl="$(curl -sx socks5://localhost:$localPort cip.cc | perl -ne 'print $1 if /^\s*IP\s*:\s*(\d+(\.\d+){3})\s*$/')"
    echo "Server from curl: ${green}$serverFromCurl${reset}"
    echo "-------------------------------------------"
    if [[ "$serverIP" == "$serverFromCurl" ]];then
        echo "${green}OK.${reset}"
    else
        echo "${red}Failed.${reset}"
    fi
}

editMyself(){
    editor=vi
    if command -v vim >/dev/null 2>&1;then
        editor=vim
    fi
    $editor $root/ssrlocal
}

status(){
    case $(uname) in
        Linux)
            systemctl status ssrlocal
            ;;
        Darwin)
            launchctl list | grep ssrlocal
            ;;
    esac
}

cmd=$1

case $cmd in
    start)
        start
        ;;
    stop)
        stop
        ;;
    status)
        status
        ;;
    restart)
        stop
        start
        ;;
    config)
        config
        ;;
    em)
        editMyself
        ;;
    ping)
        ping
        ;;
    check)
        check
        ;;
    *)
        usage
        ;;
esac
